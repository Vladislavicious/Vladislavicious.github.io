<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Metronom</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" type="text/css" href="style.css">
</head>
<body>

  <!-- меню -->

  <input type="checkbox" id="side-checkbox" />
  <div class="side-panel">
      <label class="side-button-2" for="side-checkbox"></label>
      <div class="side-title">
        <a>Навигация:</a>
      </div>
      <div class="ref-container">
        <a href="petronom.html">Переход на петроном</a>
      </div>
  </div>
  <div class="side-button-wr">
      <label class="side-button" for="side-checkbox">
          <div class="side-b side-open">Меню</div>
      </label>
  </div>

  <!-- основная часть -->

  <div class="rows">
    <div class="rows-item" id="canvasRow">
      <canvas id="myCanvas"></canvas>
    </div>

    <div class="rows-item">
      <div class="buttons-all">
        <div class="minusing">
          <label class="side-button">
            <div id="minus1" class="side-b">-1</div>
          </label>
          <label class="side-button">
            <div id="minus5" class="side-b">-5</div>
          </label>
        </div>
        <div class="tempo">
          <div class="rangeValue">
            <span id="numb">120</span>
            <input class="range" type="range" value="120" min="1" max="300" id="tempoInput"></input>
          </div>
        </div>
        <div class="plusing">
          <label class="side-button">
            <div id="plus1" class="side-b">+1</div>
          </label>
          <label class="side-button">
            <div id="plus5" class="side-b">+5</div>
          </label>
        </div>
        <div class="playButton">
          <div class="fake-player">
            <button role="play" class="play"></button>
            <button role="pause" class="pause hidden"></button>
          </div>
        </div>
        <div class="beats">
          <details>
            <summary>
              <input type="number" id="beatsInput" placeholder="Доли в такте" step="1" value="4" min="1" max="32" required>
              <script>
                document.getElementById("beatsInput").onkeypress =
                  function (e) {
                    var ev = e || window.event;
                    if(ev.charCode < 48 || ev.charCode > 57) {
                      return false; // not a digit
                    } else if(this.value * 10 + ev.charCode - 48 > this.max) {
                        return false;
                    } else {
                        return true;
                    }
                  }
              </script>
            </summary>
            Сколько долей в такте
          </details>
        </div>
        <div class="ticks">
          <details>
            <summary>
              <input type="number" id="ticksInput" placeholder="Ударов на долю" step="1" value="1" min="1" max="4" required>
              <script>
                document.getElementById("ticksInput").onkeypress =
                  function (e) {
                    var ev = e || window.event;
                    if(ev.charCode < 48 || ev.charCode > 57) {
                      return false; // not a digit
                    } else if(this.value * 10 + ev.charCode - 48 > this.max) {
                        return false;
                    } else {
                        return true;
                    }
                  }
              </script>
            </summary>
            Сколько ударов приходится на долю
          </details>
          <!-- <select name="tickSelector" selected value="1">
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5</option>
            <option value="6">6</option>
            <option value="7">7</option>
            <option value="8">8</option>
            <option value="9">9</option>
            <option value="10">10</option>
            <option value="11">11</option>
            <option value="12">12</option>
            <option value="13">13</option>
            <option value="14">14</option>
            <option value="15">15</option>
            <option value="16">16</option>
            <option value="17">17</option>
            <option value="18">18</option>
            <option value="19">19</option>
            <option value="20">20</option>
            <option value="21">21</option>
            <option value="22">22</option>
            <option value="23">23</option>
            <option value="24">24</option>
            <option value="25">25</option>
            <option value="26">26</option>
            <option value="27">27</option>
            <option value="28">28</option>
            <option value="29">29</option>
            <option value="30">30</option>
            <option value="31">31</option>
            <option value="32">32</option>
          </select> -->
        </div>
      </div>
    </div>


  </div>
  <script type="text/javascript" src="scripts/main.js"></script>
  <script>
    const canvas = document.getElementById("myCanvas");
    const context = canvas.getContext('2d');

    const tempoInput = document.getElementById("tempoInput");
    const beatsInput = document.getElementById("beatsInput");
    const ticksInput = document.getElementById("ticksInput");


    let canvas_reference;
    if (CanvasRef.instance != null)
    {
      canvas_reference = new CanvasRef();
      canvas_reference.canvas = canvas;
    }
    else
      canvas_reference = new CanvasRef(canvas)

    Drawer.initialize();
    let theme = new Theme();

    let g_metronom;
    g_metronom = Metronom.createMetronom(tempoInput.value, beatsInput.value, ticksInput.value);

    function getMetronomRef() { return g_metronom; }
    function setMetronomRef(metronom) { g_metronom = metronom; }

    const playButton = document.querySelector('.fake-player');

    function clickHandler () {
        let newMetronom = Metronom.PlayButtonPress(getMetronomRef(), tempoInput.value, beatsInput.value, ticksInput.value);
        setMetronomRef(newMetronom);

        const buttons = Array.from(this.children);
        buttons.forEach(playButton => playButton.classList.toggle('hidden'));
    };
    playButton.addEventListener('click', clickHandler);

    canvas_reference.canvas.addEventListener("mousedown", function(event)
    {
      let coordinates = canvas_reference.getMousePos(event);
      getMetronomRef().checkForIntersections(coordinates["x"], coordinates["y"]);
    });

    window.addEventListener("resize", function(event) {getMetronomRef().redrawAllCircles();});

    beatsInput.onchange = function()
    {
      if (getMetronomRef().active)
      {
        if ( getMetronomRef().beats != beatsInput.value )
          setMetronomRef(Metronom.BeatsChanged(getMetronomRef(), beatsInput.value, ticksInput.value));
      }
    }

    ticksInput.onchange = function()
    {
      if (getMetronomRef().active)
      {
        if ( getMetronomRef().ticks != ticksInput.value )
          getMetronomRef().ticks = ticksInput.value;
      }
    }
    function adjustSlider(value)
    {
      document.getElementById('numb').innerHTML = value;
    }
    function changeTempo(value)
    {
      let prevValue = Number(tempoInput.value);
      let newValue = prevValue + value;
      if (newValue <= tempoInput.max && newValue >= tempoInput.min)
      {
        if (getMetronomRef().active)
          getMetronomRef().tempo = newValue;
        tempoInput.value = newValue;
        adjustSlider(newValue);
      }
    }

    document.getElementById("plus1").addEventListener("click", function(event) { changeTempo(1); } );
    document.getElementById("plus5").addEventListener("click", function(event) { changeTempo(5); } );
    document.getElementById("minus1").addEventListener("click", function(event) { changeTempo(-1); } );
    document.getElementById("minus5").addEventListener("click", function(event) { changeTempo(-5); } );

    tempoInput.onchange = function (e) { changeTempo(0); adjustSlider(tempoInput.value); }
    tempoInput.addEventListener("touchmove", function(e)
    {
      adjustSlider(tempoInput.value);
    })
    tempoInput.onmousemove = function(e)
    {
      adjustSlider(tempoInput.value);
    }

    window.onmessage = function(e) { console.log(e); }
  </script>
</body>
</html>
